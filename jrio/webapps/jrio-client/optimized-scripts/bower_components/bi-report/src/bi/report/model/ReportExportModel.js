define(["require","common/model/BaseModel","backbone","underscore","jquery","./reportStatusTrait","../enum/reportOutputFormats"],function(t){"use strict";function e(t){var e=n.parseHTML(t);return e=o.filter(e,function(t){var e=n(t),r=e.prop("tagName");return r=r?r:"","table"===r.toLowerCase()}),0===e.length?!1:e}var r=t("common/model/BaseModel"),i=t("backbone"),o=t("underscore"),n=t("jquery"),s=t("./reportStatusTrait"),u=t("../enum/reportOutputFormats"),a=1e3,p=r.extend({defaults:function(){return{attachments:void 0,id:void 0,options:void 0,outputResource:void 0,outputFinal:!1,ignorePagination:void 0,status:void 0}},initialize:function(t,e){e||(e={}),this.report=e.report,this.isFirstRun=!0,r.prototype.initialize.apply(this,arguments)},url:function(){if(o.isUndefined(this.report.get("requestId")))throw new Error("You must execute report before fetching export.");var t=this.report.contextPath;return"/"!==t[t.length-1]&&(t+="/"),t+="rest_v2/reportExecutions/"+this.report.get("requestId")+"/exports"},urlStatus:function(){if(o.isUndefined(this.get("id")))throw new Error("Export ID is not specified");return this.url()+"/"+this.get("id")+"/status"},urlOutput:function(){if(o.isUndefined(this.get("id")))throw new Error("Export ID is not specified");return this.url()+"/"+this.get("id")+"/outputResource"},urlAttachments:function(){if(o.isUndefined(this.get("id")))throw new Error("Export ID is not specified");return this.url()+"/"+this.get("id")+"/attachments/"},run:function(t){t||(t={});var e=o.extend(this.report.execution.pick("outputFormat","pages","anchor","attachmentsPrefix","allowInlineScripts","markupType","baseUrl","ignorePagination"),this.get("options")?o.pick(this.get("options"),"outputFormat","pages","anchor","attachmentsPrefix","allowInlineScripts","markupType","baseUrl","ignorePagination"):{},t);return this.isFirstRun&&(e.clearContextCache=!0,this.isFirstRun=!1),r.prototype.fetch.call(this,{url:this.url(),type:"POST",contentType:"application/json",headers:{Accept:"application/json","x-jrs-base-url":this.report.contextPath},data:JSON.stringify(e)})},fetchOutput:function(){var t=this;return i.ajax({url:this.urlOutput(),type:"GET",headers:{Accept:"text/html, application/json","x-jrs-base-url":this.report.contextPath},dataType:this.get("options").outputFormat}).done(function(e,r,i){var n=e;t.get("options").outputFormat===u.HTML&&(n=e&&e.markup?e.markup:o.isUndefined(e)?"":e),t.set({output:n,outputFinal:"true"===i.getResponseHeader("output-final"),outputTimestamp:parseInt(i.getResponseHeader("output-timestamp"))})})},getHTMLOutput:function(){return e(this.get("output"))},updateStatus:function(){var t=this,e=i.ajax({type:"GET",url:this.urlStatus(),dataType:"json",contentType:"application/json",headers:{Accept:"application/status+json","x-jrs-base-url":this.report.contextPath}}).done(function(e){return t.set({status:e.value,errorDescriptor:e.errorDescriptor})?void t.trigger("sync",t,e):!1}).fail(function(e){t.trigger("error",t,e)});return this.trigger("request",this,e),e},waitForExport:function(){var t=this,e=new n.Deferred,r=function(){t.isCompleted()?e.resolve():setTimeout(function(){t.updateStatus().done(r).fail(e.reject)},a)};return this.updateStatus().done(r).fail(e.reject),e}});return o.extend(p.prototype,s),p});