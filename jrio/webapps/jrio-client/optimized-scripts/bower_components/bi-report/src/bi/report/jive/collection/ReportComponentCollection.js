define(["require","backbone","underscore","jquery","../enum/jiveTypes","logger"],function(e){function t(e,t){var o=n.clone(t);if(t.events){var r={};n.each(n.keys(t.events),function(o){r[o]=function(e,t){return function(o,r){e.call(this,r,n.isObject(o)?o:n.findWhere(t.getLinks(),{id:o}))}}(t.events[o],e)}),o.events=r}return o}var o=e("backbone"),n=e("underscore"),r=e("jquery"),p=e("../enum/jiveTypes"),s=e("logger").register("ReportComponentCollection");return o.Collection.extend({initialize:function(e,o){var r=this;this._parts=[],this._root=null,this.stateModel=o.stateModel,this.report=o.report,this.pageComponentsMeta=o.pageComponentsMeta,this.reportComponentsMeta=o.reportComponentsMeta,this.stateModel.get("linkOptions")&&(this.linkOptions=t(this,this.stateModel.get("linkOptions"))),this.listenTo(this.stateModel,"change:linkOptions",function(e,o){r.linkOptions=t(r,o)}),this.on("change add reset remove",function(){n.each(p,function(e){r[e]=[]}),r.forEach(function(e){r[e.get("type")]&&n.isArray(r[e.get("type")])&&r[e.get("type")].push(e)})}),this.on("reset add",function(){r.forEach(function(e){e&&e.get("type")&&("bookmarks"===e.get("type")&&r.trigger("bookmarksReady",e.get("bookmarks")),"reportparts"===e.get("type")&&r.trigger("reportPartsReady",e.get("reportParts")))})})},registerPart:function(e){var t=this;e&&(e.get("parentId")?t._root?t._root.registerPart(e):t._parts.push(e):(t._root=e,n.each(this._parts,function(e){t._root.registerPart(e)})))},fetch:function(){var t=this,o=[],p=[],s=[],i=new r.Deferred;return this.pageComponentsMeta.forEach(function(e){e.get("type")&&"table"===e.get("type")&&o.push("../model/TableComponentModel"),e.get("type")&&"column"===e.get("type")&&o.push("../model/ColumnComponentModel"),e.get("type")&&"chart"===e.get("type")&&o.push("bi/chart/jr/jive/highcharts/model/ChartComponentModel"),e.get("type")&&("fusionChart"===e.get("type")||"fusionMap"===e.get("type")||"fusionWidget"===e.get("type"))&&o.push("../model/FusionComponentModel"),e.get("type")&&"googlemap"===e.get("type")&&o.push("../model/GooglemapComponentModel"),e.get("type")&&"tibco-maps"===e.get("type")&&o.push("../model/TibcomapComponentModel"),e.get("type")&&"crosstab"===e.get("type")&&o.push("../model/CrosstabComponentModel"),e.get("type")&&"webfonts"===e.get("type")&&o.push("../model/WebfontsComponentModel"),e.get("type")&&"hyperlinks"===e.get("type")&&o.push("../model/HyperlinksComponentModel"),e.get("type")&&"bookmarks"===e.get("type")&&o.push("../model/BookmarksComponentModel"),e.get("type")&&"reportparts"===e.get("type")&&o.push("../model/ReportPartsComponentModel"),e.get("type")&&"CVComponent"===e.get("type")&&o.push("../model/CustomComponentModel"),e.get("type")&&p.push(e.attributes)}),e(o,function(){var e=n.toArray(arguments),o={parent:t.report,linkOptions:t.linkOptions,collection:t,parse:!0};n.each(e,function(e,n){var r=new e(p[n],o);s.push(r),t.registerPart(r)}),t.reset(s),i.resolve()},i.reject),i},fetchReportComponents:function(){var t=this,o=[],p=[],s=[],i=new r.Deferred;return this.reportComponentsMeta.forEach(function(e){e.get("type")&&"bookmarks"===e.get("type")&&o.push("../model/BookmarksComponentModel"),e.get("type")&&"reportparts"===e.get("type")&&o.push("../model/ReportPartsComponentModel"),e.get("type")&&p.push(e.attributes)}),e(o,function(){var e=n.toArray(arguments),o={parent:t.report,linkOptions:t.linkOptions,collection:t,parse:!0};n.each(e,function(e,n){var r=new e(p[n],o);s.push(r),t.registerPart(r)}),t.add(s),i.resolve()},i.reject),i},add:function(e,t){var r=[];return this.stateModel.get("isolateDom")&&(n.each(e,function(e,t,o){!e.get("type")||-1===e.get("type").indexOf("fusion")&&-1===e.get("type").indexOf("tibco-maps")?r.push(o[t]):(-1!==e.get("type").indexOf("fusion")&&s.info("Fusion components usage deprecated when isolateDom option enabled for report"),-1!==e.get("type").indexOf("tibco-maps")&&s.info("Tibco maps components usage deprecated when isolateDom option enabled for report"))}),e=r),o.Collection.prototype.add.call(this,e,t)},getComponents:function(){var e=this.reduce(function(e,t){if(t.toReportComponentObject){var o=t.toReportComponentObject();if(!o)return e;n.isArray(o)?e=e.concat(o):e.push(o)}return e},[]);return n.forEach(e,function(e){void 0===e.name&&delete e.name}),e},getLinks:function(){return this.reduce(function(e,t){return e.concat(t.get("hyperlinks")||[])},[])},getBookmarks:function(){return this.reduce(function(e,t){return e.concat(t.get("bookmarks")||[])},[])},getReportParts:function(){return this.reduce(function(e,t){return e.concat(t.get("reportParts")||[])},[])},updateComponents:function(e){var t=this,r=[],p=new o.Collection(this.map(function(e){var t=new o.Model(e.attributes);return n.extend(t,{updateFromReportComponentObject:e.updateFromReportComponentObject,actions:e.actions,parent:e.parent,headingFormat:e.headingFormat,detailsRowFormat:e.detailsRowFormat,conditions:e.conditions}),e.attachEvents&&e.attachEvents.call(t),t}));return p.forEach(function(e){n.each(e.actions,function(o,n){t.listenToOnce(e,n,function(e,t,o){r.push(e.actions[n].call(e,o))})})}),n.each(e,function(e){var t=p.get(e.id.split("/")[0]);t&&t.updateFromReportComponentObject(e)}),r}})});