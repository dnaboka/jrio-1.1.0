define(["require","exports","module","underscore","jquery","backbone","logger","common/bi/component/util/biComponentUtil","common/bi/component/BiComponent","common/bi/error/enum/biComponentErrorCodes","./error/biComponentErrorFactoryReportProxy","./model/ReportModel","./ReportController","./model/ReportExportModel","./model/ReportPropertiesModel","./view/ReportView","./enum/reportOutputFormats","./jive/enum/jiveTypes","./jive/enum/interactiveComponentTypes","./enum/reportEvents","text!./schema/Report.json","text!./schema/ReportExport.json","text!./schema/ReportSearch.json","text!./schema/ReportSave.json","text!./schema/Chart.json","text!./schema/CrosstabDataColumn.json","text!./schema/CrosstabRowGroup.json","text!./schema/TableColumn.json"],function(e,r,t){"use strict";function o(e){var r=null;return e&&v.keys(e).length&&(r={reportParameter:v.map(e,function(e,r){return{name:r,value:e}})}),r}function n(e,r,t,n,a){var i,s,c,p,d=this.validate(),l=this;if(d)return p=P.validationError(d),h.error(p.toString()),void e.reject(p);if(r.properties.isolateDom&&(v.isUndefined(r.properties.defaultJiveUi)||r.properties.defaultJiveUi.enabled!==!1))return p=P.genericError(T.UNSUPPORTED_CONFIGURATION_ERROR,"Default JIVE UI should be disabled when isolateDom option is true"),h.error(p.toString()),void e.reject(p);if(r.properties.container){var u=f(r.properties.container);if(!u.length||"1"!=u[0].nodeType)return p=P.containerNotFoundError(r.properties.container),h.error(p.toString()),void e.reject(p);t.view.setContainer(u)}v.isUndefined(r.properties.resource.executionId)?t.model.set("reportURI",r.properties.resource):t.model.set("executionId",r.properties.resource.executionId),t.model.contextPath=r.properties.server,O.createReadOnlyProperty(this,"server",r,!0,a),O.createReadOnlyProperty(this,"resource",r,!0,a),O.createReadOnlyProperty(this,"ignorePagination",r,!0,a),O.createReadOnlyProperty(this,"reportLocale",r,!0,a),O.createReadOnlyProperty(this,"reportTimeZone",r,!0,a),c=t.model.execution.get("parameters"),i=t.model.execution.get("pages"),s=t.model.execution.get("anchor");var m=v.isObject(r.properties.pages)?r.properties.pages.pages:r.properties.pages,E=v.isObject(r.properties.pages)?r.properties.pages.anchor:void 0;v.isUndefined(m)?(v.extend(t.model.getExport(D.HTML).get("options"),{pages:void 0,anchor:E}),t.model.execution.set({pages:void 0,anchor:E,ignorePagination:r.properties.ignorePagination,parameters:o(r.properties.params)})):(v.extend(t.model.getExport(D.HTML).get("options"),{pages:m,anchor:E}),t.model.execution.set({pages:m,anchor:E,ignorePagination:r.properties.ignorePagination,parameters:o(r.properties.params)})),r.properties.reportLocale&&t.model.execution.set({reportLocale:r.properties.reportLocale}),r.properties.reportTimeZone&&t.model.execution.set({reportTimeZone:r.properties.reportTimeZone});var R=t.model.execution.changedAttributes(),g=R&&"parameters"in R,A=R&&("pages"in R||"anchor"in R),C=function(){var e,r=f.Deferred();if(!v.isObject(t.updateComponent))return r.resolve();var o=t.updateComponent&&t.updateComponent.componentId,n=t.updateComponent&&t.updateComponent.componentProps,a=!v.isUndefined(o)&&v.findWhere(t.components.getComponents(),{name:o})||v.findWhere(t.components.getComponents(),{id:o});if(!a)throw new Error("Component with such name or id '"+o+"' was not found");var i=v.extend(a,n),s=H[i.componentType];if(!s)throw new Error("Cannot validate component - unknown component type '"+i.componentType+"'");var c=O.validateObject(s,a);if(c)e=P.validationError(c),h.error(e.toString()),r.reject(e);else{var p=t.components.updateComponents([i]);p&&v.isArray(p)&&(p=v.compact(p)),p&&v.isArray(p)&&p.length?(p.silent=!0,t.runReportAction(p).done(function(){r.resolve(v.findWhere(t.components.getComponents(),{name:o}))}).fail(function(t){"export"===t.source||"execution"===t.source?(e=P.reportStatus(t),v.include([T.REPORT_EXECUTION_FAILED,T.REPORT_EXECUTION_CANCELLED,T.REPORT_EXPORT_FAILED,T.REPORT_EXPORT_CANCELLED],e)?h.error(e.toString()):h.error("Report "+t.source+("export"===t.source?" to format '"+t.format+"'":"")+" "+t.status+": "+e.toString()),r.reject(e)):"highchartsInternalError"===t.type?(e=P.reportRender(t),h.error(e.toString()),r.reject(e)):(e=P.requestError(t),h.error(e.toString()),r.reject(e))})):r.resolve(v.findWhere(t.components.getComponents(),{name:o}))}return r},S=function(){var e=new f.Deferred;return h.debug("Starting trying to render report"),r.properties.container?t.renderReport().done(function(){try{var r=l.data();a.set("_rendered",!0),e.resolve(r)}catch(t){h.error(t.toString()),e.reject(t)}}).fail(function(r){var t=P.reportRender(r),o=t.data&&t.data.error&&t.data.error.stack?"\n"+t.data.error.stack:"";h.error(t.toString()+o),e.reject(t)}):e.resolve(l.data()),e},_=function(){S().done(function(){r.data.totalPages=t.model.get("totalPages"),r.data.components=t.components.getComponents(),r.data.links=t.components.getLinks(),r.data.bookmarks=t.components.getBookmarks(),r.data.reportParts=t.components.getReportParts(),e.resolve(l.data())}).fail(e.reject)},j=function(o){var n;t.view.hideOverlay(),g&&t.model.execution.set({parameters:c},{silent:!0}),A&&(t.model.execution.set({pages:i,anchor:s},{silent:!0}),v.isUndefined(s)?r.properties.pages=i:r.properties.pages=v.isUndefined(i)?{anchor:s}:{pages:i,anchor:s}),o.errorDescriptor&&o.errorDescriptor.errorCode?(n=P.genericError(o.errorDescriptor.errorCode,o.errorDescriptor.message,o.errorDescriptor.parameters),h.error(n.toString()),e.reject(n)):"export"===o.source||"execution"===o.source?(n=P.reportStatus(o),v.include([T.REPORT_EXECUTION_FAILED,T.REPORT_EXECUTION_CANCELLED,T.REPORT_EXPORT_FAILED,T.REPORT_EXPORT_CANCELLED],n)?h.error(n.toString()):h.error("Report "+o.source+("export"===o.source?" to format '"+o.format+"'":"")+" "+o.status+": "+n.toString()),e.reject(n)):"highchartsInternalError"===o.type?(n=P.reportRender(o),h.error(n.toString()),e.reject(n)):(n=P.requestError(o),h.error(n.toString()),e.reject(n))};t.view.showOverlay(),t.model.isNew()?t.executeReport(n).then(_,j):C().done(function(){g||n?t.applyReportParameters(n).then(_,j):A||t.updateComponent?t.fetchPageHtmlExportAndJiveComponents().then(_,j):S().then(e.resolve,e.reject)}).fail(e.reject)}function a(e,r,t,o){if(t.view.setContainer(r.properties.container)===!1){var n=P.containerNotFoundError(r.properties.container);return h.error(n.toString()),void e.reject(n)}t.renderReport().done(function(){o.set("_rendered",!0),e.resolve(t.view.$el[0])}).fail(function(r){var t=P.reportRender(r);h.error(t.toString()),e.reject(t)})}function i(e,r,t,o){if(o.get("_rendered"))t.view.applyScale(),e.resolve();else{var n=P.notYetRenderedError();h.error(n.toString()),e.reject(n)}}function s(e,r){r.cancelReportExecution().done(e.resolve).fail(function(r){var t=P.requestError(r);h.error(t.toString()),e.reject(t)})}function c(e,r){r.undoReportAction().done(e.resolve).fail(function(r){var t=P.requestError(r);h.error(t.toString()),e.reject(t)})}function p(e,r){r.undoAllReportAction().done(e.resolve).fail(function(r){var t=P.requestError(r);h.error(t.toString()),e.reject(t)})}function d(e,r){r.redoReportAction().done(e.resolve).fail(function(r){var t=P.requestError(r);h.error(t.toString()),e.reject(t)})}function l(e,r,t){r.destroy().done(function(){t.set("_destroyed",!0),e.resolve()}).fail(function(r){var t=P.requestError(r);h.error(t.toString()),e.reject(t)})}function u(e){return function(r,t,o,n){var a=new f.Deferred,i=t,s=o,c=n,p=r;v.isFunction(r)&&(p=void 0,i=r,s=t,c=o),i&&v.isFunction(i)&&a.done(i),s&&v.isFunction(s)&&a.fail(s),c&&v.isFunction(c)&&a.always(c);var d=p?O.validateObject(L,p):void 0;if(d){var l=P.validationError(d);h.error(l.toString()),a.reject(l)}else e.save(p).done(a.resolve).fail(function(e){var r,t=e&&e.responseText?JSON.parse(e.responseText):null;r=t&&t.result&&t.result.code&&t.result.msg?P.genericError(t.result.code,t.result.msg):P.requestError(e),h.error(r.toString()),a.reject(r)});return a}}function m(e,r){return function(t,o,n,a){var i,s,c;if(r.get("_destroyed"))c=P.alreadyDestroyedError(),h.error(c.toString()),i=(new f.Deferred).reject(c);else try{s=O.validateObject(N,t),s?(i=new f.Deferred,c=P.validationError(s),h.error(c.toString()),i.reject(c)):i=e.exportReport(t)}catch(p){i=new f.Deferred,c=P.javaScriptException(p),h.error(c.toString()),i.reject(c)}return i.done(o).fail(n).always(a),i}}function E(e,r){return function(t){var o,n,a;if(r.get("_destroyed"))a=P.alreadyDestroyedError(),h.error(a.toString()),o=(new f.Deferred).reject(a);else try{n=O.validateObject(b,t),n?(o=new f.Deferred,a=P.validationError(n),h.error(a.toString()),o.reject(a)):o=e.searchReportAction(t).then(function(e){var r=e;return r.result&&r.result.actionResult&&r.result.actionResult.searchResults?r.result.actionResult.searchResults:[]})}catch(i){o=new f.Deferred,a=P.javaScriptException(i),h.error(a.toString()),o.reject(a)}return o}}function R(e,r){return function(){var t,o,n,a,i,s,c=this,p=f.Deferred();if(v.isString(arguments[0])?(i=arguments[0],t=arguments[1],o=arguments[2],n=arguments[3],a=arguments[4]):(t=arguments[0],i=t.id,o=arguments[1],n=arguments[2],a=arguments[3]),o&&v.isFunction(o)&&p.done(o),n&&v.isFunction(n)&&p.fail(n),a&&v.isFunction(a)&&p.always(a),r.get("_destroyed"))s=P.alreadyDestroyedError(),h.error(s.toString()),p.reject(s);else try{e.updateComponent={componentId:i,componentProps:t},c.run().always(function(){e.updateComponent=null}).fail(function(r){e.view.hideOverlay(),p.reject(r)}).done(function(){p.resolve(!v.isUndefined(i)&&v.findWhere(e.components.getComponents(),{name:i})||v.findWhere(e.components.getComponents(),{id:i}))})}catch(d){s=P.javaScriptException(d),h.error(s.toString()),p.reject(P.javaScriptException(d))}return p}}function g(e,r,t,o){return function(n){if(o.get("_destroyed"))throw P.alreadyDestroyedError();var a=this;return n&&v.isObject(n)&&v.keys(n).length?(v.each(e.events,function(e,o){v.isFunction(e)&&(o===B.CHANGE_TOTAL_PAGES?r.stopListening(t.model,"change:totalPages",e):o===B.CAN_REDO||o===B.CAN_UNDO?r.stopListening(t.stateStack,"change:position",e):o===B.REPORT_COMPLETED?r.stopListening(t,x.REPORT_COMPLETED,e):o===B.PAGE_FINAL?r.stopListening(t,x.PAGE_FINAL,e):o===B.BEFORE_RENDER?r.stopListening(t.view,x.BEFORE_RENDER,e):o===B.CHANGE_PAGES_STATE?r.stopListening(t,x.CURRENT_PAGE_CHANGED,e):o==B.BOOKMARKS_READY?r.stopListening(t.components,B.BOOKMARKS_READY,e):o==B.REPORTPARTS_READY&&r.stopListening(t.components,B.REPORTPARTS_READY,e))}),v.each(n,function(r,o){v.isFunction(r)&&(o===B.CHANGE_TOTAL_PAGES?e.events[o]=function(){r.call(a,t.model.get("totalPages"))}:o===B.CAN_UNDO?e.events[o]=function(){r.call(a,t.stateStack.get("canUndo"))}:o===B.CAN_REDO?e.events[o]=function(){r.call(a,t.stateStack.get("canRedo"))}:o===B.PAGE_FINAL?e.events[o]=function(e){r.call(a,e)}:o===B.REPORT_COMPLETED?e.events[o]=function(e,t){if(t)try{t="export"===t.source||"execution"===t.source?P.reportStatus(t):P.requestError(t)}catch(o){t=P.javaScriptException(o)}r.call(a,e,t)}:o===B.BEFORE_RENDER?e.events[o]=v.bind(r,a):o===B.CHANGE_PAGES_STATE?e.events[o]=v.bind(r,a):o==B.BOOKMARKS_READY?e.events[o]=function(e){e.length&&r.call(a,e)}:o==B.REPORTPARTS_READY&&(e.events[o]=function(e){e.length&&r.call(a,e)}))}),v.each(e.events,function(e,o){v.isFunction(e)&&(o===B.CHANGE_TOTAL_PAGES?r.listenTo(t.model,"change:totalPages",e):o===B.CAN_REDO?r.listenTo(t.stateStack,"change:canRedo",e):o===B.CAN_UNDO?r.listenTo(t.stateStack,"change:canUndo",e):o===B.PAGE_FINAL?r.listenTo(t,x.PAGE_FINAL,e):o===B.REPORT_COMPLETED?r.listenTo(t,x.REPORT_COMPLETED,e):o===B.BEFORE_RENDER?r.listenTo(t.view,x.BEFORE_RENDER,e):o===B.CHANGE_PAGES_STATE?r.listenTo(t,x.CURRENT_PAGE_CHANGED,e):o==B.BOOKMARKS_READY?r.listenTo(t.components,B.BOOKMARKS_READY,e):o==B.REPORTPARTS_READY&&r.listenTo(t.components,B.REPORTPARTS_READY,e))}),a):a}}var v=e("underscore"),f=e("jquery"),A=e("backbone"),h=e("logger").register(t),O=e("common/bi/component/util/biComponentUtil"),C=e("common/bi/component/BiComponent"),T=e("common/bi/error/enum/biComponentErrorCodes"),P=e("./error/biComponentErrorFactoryReportProxy"),S=(e("./model/ReportModel"),e("./ReportController")),_=(e("./model/ReportExportModel"),e("./model/ReportPropertiesModel")),D=(e("./view/ReportView"),e("./enum/reportOutputFormats")),j=(e("./jive/enum/jiveTypes"),e("./jive/enum/interactiveComponentTypes")),x=e("./enum/reportEvents"),y=JSON.parse(e("text!./schema/Report.json")),N=JSON.parse(e("text!./schema/ReportExport.json")),b=JSON.parse(e("text!./schema/ReportSearch.json")),L=JSON.parse(e("text!./schema/ReportSave.json")),w=JSON.parse(e("text!./schema/Chart.json")),F=JSON.parse(e("text!./schema/CrosstabDataColumn.json")),U=JSON.parse(e("text!./schema/CrosstabRowGroup.json")),k=JSON.parse(e("text!./schema/TableColumn.json")),G=v.keys(y.properties),I=["properties"],M=["data"],B={CHANGE_TOTAL_PAGES:"changeTotalPages",CHANGE_PAGES_STATE:"changePagesState",CAN_UNDO:"canUndo",CAN_REDO:"canRedo",BEFORE_RENDER:"beforeRender",PAGE_FINAL:"pageFinal",REPORT_COMPLETED:"reportCompleted",BOOKMARKS_READY:"bookmarksReady",REPORTPARTS_READY:"reportPartsReady"},H={};H[j.CHART]=w,H[j.CROSSTAB_COLUMN]=F,H[j.CROSSTAB_ROW]=U,H[j.TABLE_COLUMN]=k;var J=function(e){e||(e={});var r=e.events,t={properties:v.extend({pages:1,autoresize:!0,chart:{},loadingOverlay:!0},e),data:{totalPages:void 0,components:[],links:[],bookmarks:[],reportParts:[]},events:{}};delete t.properties.events;var o=new _(O.cloneDeep(t.properties));O.createInstancePropertiesAndFields(this,t,G,I,M,o);var f=new S(o),h=v.extend({},A.Events);f.view.$el.addClass("visualizejs _jr_report_container_ jr"),h.listenTo(f.model,"change:totalPages",function(){t.data.totalPages=f.model.get("totalPages")}),h.listenTo(f.components,"change add reset remove",function(){t.data.components=f.components.getComponents(),t.data.links=f.components.getLinks(),t.data.bookmarks=f.components.getBookmarks(),t.data.reportParts=f.components.getReportParts()}),v.extend(this,{validate:O.createValidateAction(t,y,o),run:O.createDeferredAction(n,o,t,f,!1,o),refresh:O.createDeferredAction(n,o,t,f,!0,o),render:O.createDeferredAction(a,o,t,f,o),resize:O.createDeferredAction(i,o,t,f,o),cancel:O.createDeferredAction(s,o,f),undo:O.createDeferredAction(c,o,f),undoAll:O.createDeferredAction(p,o,f),redo:O.createDeferredAction(d,o,f),search:E(f,o),save:u(f),destroy:O.createDeferredAction(l,o,f,o),"export":m(f,o),updateComponent:R(f,o),events:g(t,h,f,o)}),this.events(r)};return J.prototype=new C,v.extend(J,{exportFormats:["pdf","xlsx","xls","rtf","csv","xml","odt","ods","docx","pptx","json"],chart:{componentTypes:["chart"],types:w.properties.chartType["enum"]},table:{componentTypes:["tableColumn"],column:{types:["numeric","boolean","datetime","string","time"]}},crosstab:{componentTypes:["crosstabDataColumn","crosstabRowGroup"]}}),J});